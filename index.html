<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Using GitLab CI slides</title>

		<meta name="description" content="Using Gitlab and Gitlab CI in Lingvokot">
		<meta name="author" content="Max Sysoev">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/night.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<!--   data-background="rgb(85,68,136)" -->
				<!--  style="color: rgba(255, 255, 255, 0.62)" -->
				<!--  data-transition="zoom" -->
				<section>
					<h1>Gitlab and Lingvokot</h1>
					<div class="" style="display: flex; flex: 1; align-items: center; justify-content: center;">
						<img src="images/gitlab.svg" alt="" class="plain" style="height: 150px; flex: 0;">
						<span style="font-size: 150px; line-height: 1;">+</span>
						<div><img src="images/lingvokot.png" alt="" class="plain" style="height: 150px;"></div>
					</div>
				</section>

				<section>
					<section>
						<h2>Gitlab</h2>
					</section>

					<section>
						<h3>Almost same as GitHub</h3>
						<h4>Organizations</h4>
						<img src="images/gitlab-organizations.png">
					</section>

					<section>
						<h3>Almost same as GitHub</h3>
						<h4>Projects</h4>
						<img src="images/gitlab-projects.png">
					</section>

					<section>
						<h3>Almost same as GitHub</h3>
						<h4>Issues</h4>
						<img src="images/gitlab-issues.png">
					</section>

					<section>
						<h3>Almost same as GitHub</h3>
						<h4>Issues with Labels</h4>
						<img src="images/gitlab-issues-labels.png">
					</section>

					<section>
						<h3>Almost same as GitHub</h3>
						<h4><b>Pull</b> Requests named as <b>Merge</b> Requests</h4>
						<img src="images/gitlab-merge-requests.png">
					</section>

					<section>
						<h3>Almost same as GitHub</h3>
						<h4>Milestones</h4>
						<img src="images/gitlab-milestones.png">
					</section>

					<section>
						<h3>Almost same as GitHub</h3>
						<h4>Tags</h4>
						<img src="images/gitlab-tags.png">
					</section>

					<section>
						and other...
						<div class="fragment">...but</div>
					</section>

					<section>
						<h3>Integrated CI</h3>
						<h4>Pipelines</h4>
						<div>Combination of actions: <i>test</i>, <i>build</i>, <i>deploy</i></div>
						<img src="images/gitlab-pipelines.png">
					</section>

					<section>
						<h3>Integrated CI</h3>
						<h4>Builds</h4>
						<div>Job run: logs and result</div>
						<img src="images/gitlab-builds.png">
					</section>
				</section>

				<section>
					<section>
						<h2>Gitlab Continuous Integration</h2>
					</section>

					<section>
						<h2>Short info about Gitlab&nbsp;CI differences</h2>
						<div class="fragment"><dt>Runner</dt><dd>A server that processes builds. It receives commands from GitLab&nbsp;CI.</dd></div>
						<div class="fragment"><dt>Build</dt><dd>Execution of a particular job.</dd></div>
						<div class="fragment"><dt>Job</dt><dd>"Wrapped" bash script (before_script, "only" git ref, runner tags, cache...)</dd></div>
						<div class="fragment"><dt>Stage</dt><dd>Group of jobs. Builds of next stage are run after success of previous.</dd></div>
						<div class="fragment"><dt>Environment</dt><dd>Just a group of deploy jobs for now. Later will have approvement for each environment in chain.</dd></div>
					</section>

					<section>
						<h2>Easy setup</h2>
						<div class="fragment">
							<h3>Add runners</h3>
							<img src="images/gitlab-runners.png">
						</div>
					</section>

					<section>
						<h2>Easy setup</h2>
						<h3>Add <i>.gitlab-ci.yml</i></h3>
						<img src="images/gitlab-ci-yml.png">
					</section>

					<section>
						<h2>Custom addons</h2>
						<h3>Badges</h3>
						<img src="images/gitlab-badges.png" alt="">
						Generated by bash shell script in Gitlab CI job.
					</section>

					<section>
						<h2>Custom addons</h2>
						<h3>Badges</h3>
						<p>Actually they are links to our static WEB server,</p>
						<p>where gets exported coverage info, static analysis results</p>
					</section>

					<section>
						<h2>Coverage on WEB Server</h2>
						<p>Generated by Jest, test runner used with React Native</p>
						<img src="images/gitlab-coverage.png">
					</section>

					<section>
						<h2>Static analysis WEB Server</h2>
						<p>Generated by Plato</p>
						<img src="images/gitlab-analysis.png">
					</section>

					<section>
						<h2>More info</h2>
						<p>See in this presentation:</p>
						<p><a href="https://github.com/Lingvokot/using-gitlab-ci">Using Gitlab CI</a></p>
					</section>
				</section>

				<section>
					<section>
						<h2>Gitlab Continuous Delivery</h2>
					</section>

					<section>
						<h2>TL;DR: How to create CD process</h2>
						<p>both for <i>beta</i> and <i>prod</i></p>
						<ul>
							<li class="fragment">Find a tool for working with stores (upload apk, ipa, upload metadata of app), get wraps for xcode, gradle</li>
							<li class="fragment">Export your secrets (keys, accounts) into servers, make these servers tagged Gitlab CI runners</li>
							<li class="fragment">Create a super-tweaked job in <i>.gitlab-ci.yml</i></li>
						</ul>
					</section>

					<section>
						<h2>"a tool for stores"</h2>
						<div class="fragment">
							<h3>Fastlane</h3>
							<img src="images/fastlane-landing.png">
						</div>
					</section>

					<section>
						<h2>Fastlane can (for us)...</h2>
						<ul>
							<li class="fragment">Run native tests (still a TODO)</li>
							<li class="fragment">Build & sign xcode project in a CLI with dozen options (builds gradle projects for sure)</li>
							<li class="fragment">Upload builded bundle (apk, ipa) to store on all 3 channels for GPlay and TestFlight+AppStore for iOS</li>
							<li class="fragment">Also, upload app metadata (screenshots, description, changelogs...) on that stores</li>
							<li class="fragment">Send slack messages by the way (may be useless...)</li>
						</ul>
					</section>

					<section>
						<h2>And magic Gitlab CI job</h2>
						<p class="fragment">Not so magic, but how to do it?</p>
						<p class="fragment"><b>A Condition:</b> Fastlane lanes are written (build, deploy for android & iOS), remote servers handle it just fine, they attached to Gitlab CI as runners and have tags</p>
						<ul>
							<li class="fragment"><b>Build</b>: Job depends on <i>npm test</i> job. run <i>fastlane ios build</i> on a <b>build</b> stage, capture your XCode archive and <i>ipa</i> as <i>artifacts</i></li>
							<li class="fragment"><b>Deploy</b>: Job depends on <i>build</i> job. run <i>fastlane ios beta</i> on a <b>deploy</b> stage, on some environment <i>beta</i> and <i>prod</i></li>
							<li class="fragment">Almost same for android</li>
						</ul>
					</section>

					<section>
						<h2>A code snippet for ios build</h2>
						<p>Notice that react-native packager terrible workaround</p>
						<pre data-trim data-noescape>
ios:build:
  before_script:
    - source /etc/profile
    - export PATH="$CI_PROJECT_DIR/node_modules/.bin:$PATH"
    - nvm use
    - npm set progress=false && npm prune && npm install && npm set progress=true
  stage: build
  script:
    - react-native start &
    - sleep 2
    - kill_packager () { kill -9 $(lsof -n -ti4TCP:8081); kill -9 $(lsof -at -c node -c watchman $CI_PROJECT_DIR $CI_PROJECT_DIR/node_modules/react-native/packager); }
    - fastlane ios build && kill_packager || (kill_packager; exit 2)
  dependencies:
    - run:node
  artifacts:
    paths:
      - Break a Сode.ipa
      - Mastermind.xcarchive
  tags:
    - nvm
    - xcode
    - fastlane
  cache:
    key: "$CI_BUILD_REF_NAME"
    paths:
      - node_modules/
		</pre>
					</section>

					<section>
						<h2>Code snippet for ios deploy to TestFlight</h2>
						<pre>
ios:deploy:beta:
  before_script:
    - source /etc/profile
  stage: deploy
  environment: beta
  script:
    - export FL_IOS_BUILD_VERSION=$(git describe --tags  --abbrev=0 \
			 --contain --match "v[0-9]*" 2>/dev/null | \
			   sed 's/.*v\([0-9\.]*\).*/\1/' 2>/dev/null);
    - '[ "$FL_IOS_BUILD_VERSION" ] \
			 && echo "Deploy $FL_IOS_BUILD_VERSION to beta" \
			 || (echo "Skip deploy to beta channel" 1>&2 ; exit 2)'
    - fastlane ios beta
  only:
    - /^v[0-9\.]+$/
  dependencies:
    - ios:build
  tags:
    - xcode
    - fastlane
						</pre>
					</section>

					<section>
						<h2>About versioning</h2>
						<p>A contract: <i>v1.0</i> for <i>beta</i> releases, <i>v1.0-production</i> for production releases</p>
						<ul>
							<li class="fragment">Use <i>git tags</i> for deployment</li>
							<li class="fragment">Restrict executing of deploy jobs for that git tags with a regexp: <i>/^v[0-9\.]+/</i> for beta and <i>/^v[0-9\.]+-production/</i> </li>
							<li class="fragment">Use <i>git commit count</i> as a <i>version code</i> (xcode) or <i>build number</i> (gradle)</li>
							<li class="fragment">In a job scripts, capture <i>git tag</i> and use it as <i>version name</i></li>
							<li class="fragment">If no <i>git tag</i> specified, use <i>0.0.1</i> by default (fallback)</li>
						</ul>
					</section>

					<section>
						<h2>Code for versioning</h2>
						<pre>
SHORT_VERSION=$(git --git-dir="${PROJECT_DIR}/../.git" describe \
			 --tags  --abbrev=0 --contain --match "v[0-9]*" | \
			 	 sed 's/.*v\([0-9\.]*\).*/\1/' 2>/dev/null)

VERSION=$(git --git-dir="${PROJECT_DIR}/../.git" rev-list \
				 --no-merges --count master)

APP_INFO_PLIST_PATH="${TARGET_BUILD_DIR}/${INFOPLIST_PATH}"

defaults write  "$APP_INFO_PLIST_PATH" CFBundleShortVersionString $SHORT_VERSION
defaults write "$APP_INFO_PLIST_PATH" CFBundleVersion $VERSION
						</pre>
					</section>
				</section>

				<section>
					<section>
						<h2>React Native and friends</h2>
					</section>

					<section>
						<h2>Bootstrappin</h2>
						<p>React Native provides generator which created xcode project and android project</p>
						<p>Next steps: <i>npm install</i>, code and have fun!</p>
					</section>

					<section>
						<h2>Things to use with RN</h2>
						<ul>
							<li class="fragment">Eslint <i>with custom .eslintrc</i></li>
							<li class="fragment">Flow (integrates with Nuclide, RN IDE)</li>
							<li class="fragment">Jest (test runner)</li>
							<li class="fragment">Redux (mix of flux, elm...)</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h2>Workflow</h2>
					</section>

					<section>
						<h3>Github flow</h3>
						<ul>
							<li class="fragment">Master is always stable and deployable</li>
							<li class="fragment">For every feature (or bugfix) new branch is created from master</li>
							<li class="fragment">Developer pushes feature branch on a server many times</li>
							<li class="fragment">After work seems done, developer creates Pull Request into master</li>
							<li class="fragment">After PR gets merged into master, feature branch is removed</li>
						</ul>
					</section>

					<section>
						<h2>Redux ducks</h2>
						<p>TL;DR; actionCreators, actionTypes, reducers are in one file</p>
						<p>And:</p>
						<ul>
							<li>ducks <i>export default</i> a reducer function</li>
							<li><i>exports</i> actionTypes and actionCreators as <i>named exports</i></li>
							<li><i>actionType</i> naming form: <i>module/action</i></li>
							<li><i>actionType</i> variable is <i>UPPER_UNDERSCORE_CASE</i></li>
						</ul>
					</section>

					<section>
						<h2>Our file structure</h2>
						<p>A bunch of modules</p>
						<img src="images/module.png" alt="">
					</section>

					<section>
						<h2>Will this work?</h2>
						<div class="fragment">NO (about 60% of files are inside of /game/)</div>
						<img src="images/mastermind-file-tree.png" alt="">
					</section>

					<section>
						<h2>How my commit gets deployed?</h2>
						<ol>
							<li class="fragment">It gets reviewed on Merge Request first</li>
							<li class="fragment">At same time, CI server runs [unit] tests and analyzes coverage</li>
							<li class="fragment">After commit gets merged into <i>master</i>, CI server runs [unit] tests for <i>master</i> branch</li>
							<li class="fragment">After "Green", <i>build</i> job are launched for iOS and android in parallel, resulting in artifacts (ipa + apk)</li>
							<li class="fragment">Then, after "Green" build, on a <i>master</i> branch, nothing is happened</li>
							<li class="fragment">We download artifacts, launch and test (if you want), then add a tag on that commit</li>
							<li class="fragment">Gitlab CI runs all sequence of test+build for tag ref (v1.0)</li>
							<li class="fragment">Then, finally, it runs deploy job for git tag ref. Channel (beta, prod) is selected by tag name (v1.0 for beta, v1.0-production for production)</li>
						</ol>
					</section>

					<section>
						<h2>Rollback</h2>
						<p>Stores are immutable, so you need to add a next version with <i>patch</i> version bump and release it</p>
						<pre>
v1.0
	➡️ OMG, fail
		➡️ <i>git bisect</i> to stable or fix a bug
			➡️ v1.0.1</pre>
					</section>
				</section>

				<section>
					<h2>Questions?</h2>
				</section>

				<section style="text-align: left;">
					<h1>THE END</h1>
					<p>
						Presentation Max Sysoev. My GitHub: <a href="https://github.com/ColCh">github.com/ColCh</a> <br>
						Our organization on GitHub: <a href="https://github.com/Lingvokot">github.com/Lingvokot</a>
					</p>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
